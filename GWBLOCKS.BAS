10 DEFINT A-Z: GOSUB 720: END
20 FULLROW = 0
30 FOR PITY = 0 TO 15
40 FULLROW = -1
50 FOR PITX = 0 TO 9
60 IF MID$(PIT$, ((10 * PITY) + PITX) + 1, 1) = "0" THEN FULLROW = 0: GOTO 80
70 NEXT PITX
80 IF FULLROW THEN REMOVEDROW = PITY: GOSUB 920
90 NEXT PITY
100 RETURN
110 DROPRATE! = 1
120 SHAPE = CINT(RND * 6)
130 SHAPEANGLE = CINT(RND * 3)
140 NEWANGLE = SHAPEANGLE
150 GOSUB 410
160 SHAPEMAP$ = ROTATEDMAP$
170 GOSUB 350
180 SHAPEX = RANDOMSHAPEX
190 SHAPEY = -4
200 RETURN
210 COLOR 4: LOCATE 3, 2
220 IF GAMEOVER THEN PRINT "Game over.": LOCATE , 2: PRINT "Press Enter to play a new game.";  ELSE PRINT "Score:"; SCORE;
230 RETURN
240 LINE (116, 32)-STEP(92, 145), 15, B
250 LINE (116, 32)-STEP(92, 0), 0
260 FOR PITY = 0 TO 15
270 Y = PITY * 9
280 FOR PITX = 0 TO 9
290 IF GAMEOVER THEN BLOCKCOLOR$ = "4" ELSE BLOCKCOLOR$ = MID$(PIT$, ((10 * PITY) + PITX) + 1, 1)
300 X = PITX * 9
310 LINE (X + 117, Y + 32)-STEP(9, 9), VAL("&H" + BLOCKCOLOR$), BF
320 LINE (X + 118, Y + 33)-STEP(6, 6), 0, B
330 NEXT PITX: NEXT PITY
340 RETURN
350 INTENDEDSHAPEX = INT((RND * 10) - 1): RANDOMSHAPEX = 0
360 FOR XMOVE = 0 TO INTENDEDSHAPEX
370 MOVEDMAP$ = SHAPEMAP$: XDIRECTION = 1: YDIRECTION = 0: GOSUB 510
380 IF CANMOVE THEN RANDOMSHAPEX = RANDOMSHAPEX + 1 ELSE RETURN
390 NEXT XMOVE
400 RETURN
410 IF NEWANGLE = 0 THEN ROTATEDMAP$ = MAPS$(SHAPE): RETURN
420 ROTATEDMAP$ = STRING$(4 * 4, "0")
430 FOR BLOCKX = 0 TO 3
440 FOR BLOCKY = 0 TO 3
450 IF NEWANGLE = 1 THEN NEWBLOCKX = 3 - BLOCKY: NEWBLOCKY = BLOCKX
460 IF NEWANGLE = 2 THEN NEWBLOCKX = 3 - BLOCKX: NEWBLOCKY = 3 - BLOCKY
470 IF NEWANGLE = 3 THEN NEWBLOCKX = BLOCKY: NEWBLOCKY = 3 - BLOCKX
480 MID$(ROTATEDMAP$, ((4 * NEWBLOCKY) + NEWBLOCKX) + 1, 1) = MID$(MAPS$(SHAPE), ((4 * BLOCKY) + BLOCKX) + 1, 1)
490 NEXT BLOCKY: NEXT BLOCKX
500 RETURN
510 CANMOVE = -1
520 FOR BLOCKY = 0 TO 3
530 Y = 4 * BLOCKY
540 FOR BLOCKX = 0 TO 3
550 IF NOT MID$(MOVEDMAP$, (Y + BLOCKX) + 1, 1) = "0" THEN GOSUB 580
560 NEXT BLOCKX: NEXT BLOCKY
570 RETURN
580 PITX = (SHAPEX + BLOCKX) + XDIRECTION: PITY = (SHAPEY + BLOCKY) + YDIRECTION
590 IF PITX >= 0 AND PITX < 10 AND PITY >= 0 AND PITY < 16 THEN IF NOT MID$(PIT$, (((10 * PITY) + PITX) + 1), 1) = "0" THEN CANMOVE = 0: RETURN
600 IF PITX < 0 OR PITX >= 10 OR PITY >= 16 THEN CANMOVE = 0: RETURN
610 RETURN
620 RANDOMIZE TIMER: KEY OFF: PLAY "ML L64": SCREEN 7: CLS : COLOR 9
630 MAPS$(0) = "0000333300000000": MAPS$(1) = "0000111000100000": MAPS$(2) = "0000666060000000": MAPS$(3) = "00000EE00EE00000": MAPS$(4) = "0000022022000000": MAPS$(5) = "0000555005000000": MAPS$(6) = "0000440004400000"
640 LOCATE 1, 1: PRINT "GWBlocks v1.02": PRINT "By: Peter Swinkels, ***2021***";
650 GOSUB 110
660 GAMEOVER = 0
670 PIT$ = STRING$(10 * 16, "0")
680 SCORE = 0
690 GOSUB 240
700 GOSUB 210
710 RETURN
720 GOSUB 620
730 STARTTIME! = TIMER
740 WHILE NOT KEYV$ = CHR$(27)
750 KEYV$ = ""
760 WHILE KEYV$ = ""
770 IF (NOT GAMEOVER) AND (TIMER >= STARTTIME! + DROPRATE! OR STARTTIME! > TIMER) THEN GOSUB 1120: STARTTIME! = TIMER
780 KEYV$ = INKEY$
790 WEND
800 IF KEYV$ = CHR$(27) THEN SCREEN 0: WIDTH 80: KEY ON: RETURN
810 IF GAMEOVER AND KEYV$ = CHR$(13) THEN GOSUB 620
820 IF GAMEOVER THEN GOTO 910
830 GOSUB 1370
840 IF KEYV$ = "A" OR KEYV$ = "a" THEN GOSUB 990
850 IF KEYV$ = CHR$(0) + "K" THEN MOVEDMAP$ = SHAPEMAP$: XDIRECTION = -1: YDIRECTION = 0: GOSUB 510
860 IF KEYV$ = CHR$(0) + "K" AND CANMOVE THEN SHAPEX = SHAPEX - 1
870 IF KEYV$ = CHR$(0) + "M" THEN MOVEDMAP$ = SHAPEMAP$: XDIRECTION = 1: YDIRECTION = 0: GOSUB 510
880 IF KEYV$ = CHR$(0) + "M" AND CANMOVE THEN SHAPEX = SHAPEX + 1
890 IF KEYV$ = " " THEN DROPRATE! = 0
900 GOSUB 1260
910 WEND
920 FOR PITROW = REMOVEDROW TO 0 STEP -1
930 FOR PITX = 0 TO 10 - 1
940 IF PITROW = 0 THEN BLOCKCOLOR$ = "0" ELSE BLOCKCOLOR$ = MID$(PIT$, ((10 * (PITROW - 1)) + PITX) + 1, 1)
950 MID$(PIT$, ((10 * PITROW) + PITX) + 1, 1) = BLOCKCOLOR$
960 NEXT PITX: NEXT PITROW
970 SCORE = SCORE + 1
980 RETURN
990 IF SHAPEANGLE = 3 THEN NEWANGLE = 0 ELSE NEWANGLE = SHAPEANGLE + 1
1000 GOSUB 410
1010 MOVEDMAP$ = ROTATEDMAP$: XDIRECTION = 0: YDIRECTION = 0: GOSUB 510
1020 IF CANMOVE THEN SHAPEANGLE = NEWANGLE: SHAPEMAP$ = ROTATEDMAP$
1030 RETURN
1040 PLAY "N21"
1050 FOR BLOCKY = 0 TO 3
1060 Y = 4 * BLOCKY
1070 FOR BLOCKX = 0 TO 3
1080 PITX = SHAPEX + BLOCKX: PITY = SHAPEY + BLOCKY
1090 IF (PITX >= 0 AND PITX < 10 AND PITY >= 0 AND PITY < 16) AND (NOT MID$(SHAPEMAP$, (Y + BLOCKX) + 1, 1) = "0") THEN MID$(PIT$, ((10 * PITY) + PITX) + 1, 1) = MID$(SHAPEMAP$, ((4 * BLOCKY) + BLOCKX) + 1, 1)
1100 NEXT BLOCKX: NEXT BLOCKY
1110 RETURN
1120 MOVEDMAP$ = SHAPEMAP$: XDIRECTION = 0: YDIRECTION = 1: GOSUB 510
1130 IF CANMOVE THEN GOSUB 1150 ELSE GOSUB 1190
1140 RETURN
1150 GOSUB 1370
1160 IF DROPRATE! = 1 THEN SOUND 37, .3
1170 SHAPEY = SHAPEY + 1: GOSUB 1260
1180 RETURN
1190 GOSUB 1040
1200 GAMEOVER = (SHAPEY < 0)
1210 GOSUB 20
1220 GOSUB 240
1230 GOSUB 210
1240 IF NOT GAMEOVER THEN GOSUB 110: GOSUB 1260
1250 RETURN
1260 FOR BLOCKX = 0 TO 3
1270 FOR BLOCKY = 0 TO 3
1280 PITX = SHAPEX + BLOCKX: PITY = SHAPEY + BLOCKY
1290 IF PITX >= 0 AND PITX < 10 AND PITY >= 0 AND PITY < 16 THEN GOSUB 1320
1300 NEXT BLOCKY: NEXT BLOCKX
1310 RETURN
1320 BLOCKCOLOR$ = MID$(SHAPEMAP$, ((4 * BLOCKY) + BLOCKX) + 1, 1)
1330 IF BLOCKCOLOR$ = "0" THEN BLOCKCOLOR$ = MID$(PIT$, ((10 * PITY) + PITX) + 1, 1)
1340 LINE ((PITX * 9) + 117, (PITY * 9) + 32)-STEP(9, 9), VAL("&H" + BLOCKCOLOR$), BF
1350 LINE ((PITX * 9) + 118, (PITY * 9) + 33)-STEP(6, 6), 0, B
1360 RETURN
1370 FOR BLOCKX = 0 TO 3
1380 FOR BLOCKY = 0 TO 3
1390 PITX = SHAPEX + BLOCKX: PITY = SHAPEY + BLOCKY
1400 IF PITX >= 0 AND PITX < 10 AND PITY >= 0 AND PITY < 16 THEN LINE ((PITX * 9) + 117, (PITY * 9) + 32)-STEP(9, 9), VAL("&H" + MID$(PIT$, ((10 * PITY) + PITX) + 1, 1)), BF
1410 NEXT BLOCKY: NEXT BLOCKX
1420 RETURN

